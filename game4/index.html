<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
<title>Dig Rush — Amblyopia Friendly</title>
<style>
  body { margin:0; font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial; background:#081019; color:#eaeef2; }
  canvas { display:block; margin:0 auto; background:#000; touch-action:none; }
  #settingsBtn { position:fixed; top:10px; right:10px; z-index:20; font-size:24px; background:#13a2ff; color:#001; border:none; border-radius:8px; width:44px; height:44px; }
  #settingsPanel { position:fixed; top:0; right:-320px; width:300px; height:100%; background:#0b1420; padding:14px; transition:right 0.3s; overflow-y:auto; z-index:15; }
  #settingsPanel.show { right:0; }
  label { display:block; margin-top:10px; font-size:13px; }
  input[type=range]{ width:100%; }
  .btn { background:#13a2ff; color:#001; border:none; padding:8px 12px; border-radius:8px; font-weight:600; cursor:pointer; margin-top:6px; }
  .hud { text-align:center; margin-top:6px; font-weight:bold; }
</style>
</head>
<body>

<button id="settingsBtn">⚙</button>
<div id="settingsPanel">
  <button class="btn" id="backBtn">← Back to Home</button>
  <h3>Therapy Settings</h3>
  <label>Left Eye Clarity (<span id="leftPct">100</span>%)<input type="range" min="0" max="1" step="0.05" id="leftClarity" value="1"></label>
  <label>Right Eye Clarity (<span id="rightPct">40</span>%)<input type="range" min="0" max="1" step="0.05" id="rightClarity" value="0.4"></label>
  <label><input type="checkbox" id="swapChannels"> Swap Channels (flip red/cyan)</label>
  <label><input type="checkbox" id="anaglyph" checked> Anaglyph Mode</label>
</div>

<div class="hud">Level: <span id="levelNum">1</span> | Gold: <span id="goldNum">0</span>/<span id="goldGoal">5</span></div>
<canvas id="game" width="900" height="540"></canvas>

<script>
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
let width=canvas.width, height=canvas.height;

// Offscreen canvases for left/right eye
const offL = document.createElement('canvas');
const offR = document.createElement('canvas');
offL.width=offR.width=width; offL.height=offR.height=height;
const ctxL = offL.getContext('2d'), ctxR = offR.getContext('2d');

let running=true;
let level=1, gold=0, goldGoal=5;
let anaglyph=true, swapChannels=false, leftClarity=1, rightClarity=0.4;

// Blocks grid
const cols=10, rows=12, blockSize=width/cols;
let blocks=[];

// Touch state
let digX=-1, digY=-1;

// Initialize blocks
function genBlocks(){
  blocks=[];
  for(let y=0;y<rows;y++){
    let row=[];
    for(let x=0;x<cols;x++){
      row.push({hits:y<rows-1?1+y%3:0, hasGold:(y===rows-1&&Math.random()<0.3)}); 
    }
    blocks.push(row);
  }
}

function drawEye(ctx, clarity){
  ctx.clearRect(0,0,width,height);
  for(let y=0;y<rows;y++){
    for(let x=0;x<cols;x++){
      const b=blocks[y][x];
      if(b.hits>0){
        ctx.fillStyle=`rgba(${50*clarity},${50*clarity},${50*clarity},1)`;
        ctx.fillRect(x*blockSize,y*blockSize,blockSize-2,blockSize-2);
      }
      if(b.hasGold){
        ctx.fillStyle=`rgba(255,215,0,${clarity})`;
        ctx.beginPath();
        ctx.arc(x*blockSize+blockSize/2,y*blockSize+blockSize/2,blockSize/4,0,Math.PI*2);
        ctx.fill();
      }
    }
  }
  // draw digger
  if(digX>=0 && digY>=0){
    ctx.fillStyle = `rgba(${Math.floor(255*clarity)},0,${Math.floor(255*(1-clarity))},${clarity})`;
    const cx = digX*blockSize + blockSize/2;
    const cy = digY*blockSize + blockSize/2;
    ctx.beginPath();
    ctx.arc(cx,cy,blockSize/4,0,Math.PI*2);
    ctx.fill();
  }
}

function composite(){
  ctx.clearRect(0,0,width,height);
  if(!anaglyph){
    ctx.drawImage(offL,0,0); ctx.globalAlpha=0.6; ctx.drawImage(offR,0,0); ctx.globalAlpha=1;
    return;
  }
  const tmp=document.createElement('canvas'); tmp.width=width; tmp.height=height;
  const tctx=tmp.getContext('2d');
  
  tctx.clearRect(0,0,width,height); tctx.drawImage(offL,0,0);
  tctx.globalCompositeOperation='source-atop';
  tctx.fillStyle=`rgba(0,255,255,${swapChannels?rightClarity:leftClarity})`;
  tctx.fillRect(0,0,width,height); tctx.globalCompositeOperation='source-over';
  ctx.drawImage(tmp,0,0);

  tctx.clearRect(0,0,width,height); tctx.drawImage(offR,0,0);
  tctx.globalCompositeOperation='source-atop';
  tctx.fillStyle=`rgba(255,0,0,${swapChannels?leftClarity:rightClarity})`;
  tctx.fillRect(0,0,width,height); tctx.globalCompositeOperation='source-over';
  ctx.globalCompositeOperation='lighter';
  ctx.drawImage(tmp,0,0);
  ctx.globalCompositeOperation='source-over';
}

function loop(){
  if(running){
    drawEye(ctxL,leftClarity); drawEye(ctxR,rightClarity); composite();
    requestAnimationFrame(loop);
  }
}

function dig(){
  if(digX>=0 && digY>=0 && blocks[digY] && blocks[digY][digX]){
    let b=blocks[digY][digX];
    if(b.hits>0) b.hits--;
    if(b.hits===0 && b.hasGold){ gold++; b.hasGold=false; updateHUD(); if(gold>=goldGoal){ nextLevel(); } }
  }
}

// touch handlers with proper scaling
function handleTouch(e){
  const rect=canvas.getBoundingClientRect();
  const t=e.touches[0];
  digX = Math.floor((t.clientX - rect.left)/rect.width*cols);
  digY = Math.floor((t.clientY - rect.top)/rect.height*rows);
  dig();
  e.preventDefault();
}
canvas.addEventListener('touchstart', handleTouch);
canvas.addEventListener('touchmove', handleTouch);

function nextLevel(){
  level++; gold=0; goldGoal+=2; updateHUD(); genBlocks();
}

function updateHUD(){
  document.getElementById('levelNum').textContent=level;
  document.getElementById('goldNum').textContent=gold;
  document.getElementById('goldGoal').textContent=goldGoal;
}

// Settings panel
const settingsBtn=document.getElementById('settingsBtn');
const settingsPanel=document.getElementById('settingsPanel');
settingsBtn.onclick=()=>{ settingsPanel.classList.toggle('show'); }
document.getElementById('backBtn').onclick=()=>{ window.location='../index.html'; }

document.getElementById('anaglyph').onchange=(e)=>{ anaglyph=e.target.checked; }
document.getElementById('swapChannels').onchange=(e)=>{ swapChannels=e.target.checked; }
document.getElementById('leftClarity').oninput=(e)=>{ leftClarity=parseFloat(e.target.value); document.getElementById('leftPct').textContent=Math.round(leftClarity*100);}
document.getElementById('rightClarity').oninput=(e)=>{ rightClarity=parseFloat(e.target.value); document.getElementById('rightPct').textContent=Math.round(rightClarity*100);}

// Start game
genBlocks(); updateHUD(); loop();
</script>
</body>
</html>