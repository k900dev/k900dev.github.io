<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Amblyopia Shape Tracer</title>
<style>
  body {
    margin: 0;
    background: #d0d0d0;
    font-family: sans-serif;
    overflow: hidden;
  }
  canvas {
    border: 1px solid #888;
    background: #d0d0d0;
    display: block;
    margin: 0 auto;
  }
  .controls {
    position: fixed;
    top: 10px;
    right: 0;
    width: 250px;
    background: #fff;
    border-left: 1px solid #888;
    padding: 10px;
    box-shadow: -2px 0 5px rgba(0,0,0,0.3);
    transform: translateX(250px);
    transition: transform 0.3s ease;
    z-index: 1000;
  }
  .controls.open { transform: translateX(0); }
  .controls h3 { margin-top:0; }
  .toggle-btn {
    position: fixed;
    top: 10px;
    right: 0;
    z-index: 1100;
    padding: 8px 12px;
    cursor: pointer;
    background: #007acc;
    color: white;
    border: none;
  }
  .controls label { display:block; margin:10px 0 5px; font-size: 14px;}
  .controls input[type=color], .controls input[type=range] { width: 100%; }
  .controls input[type=checkbox] { transform: scale(1.2); margin-right: 5px;}
  .game-buttons {
    position: fixed;
    bottom: 10px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 1000;
    display: flex;
    gap: 10px;
  }
  .game-buttons button { padding: 8px 16px; font-size: 16px; }
</style>
</head>
<body>

<h2 style="text-align:center;">Amblyopia-Friendly Shape Tracer</h2>
<canvas id="drawCanvas"></canvas>

<button class="toggle-btn" id="toggleSettings">Settings ⚙️</button>

<div class="controls" id="settingsPanel">
  <h3>Therapy Settings</h3>
  <label>Left Eye Colour: <input type="color" id="leftColor" value="#0000ff"></label>
  <label>Right Eye Colour: <input type="color" id="rightColor" value="#ff0000"></label>
  <label><input type="checkbox" id="swapColors"> Swap Colours</label>
  <label>Left Eye Clarity: <input type="range" id="leftClarity" min="0" max="1" step="0.05" value="1"></label>
  <label>Right Eye Clarity: <input type="range" id="rightClarity" min="0" max="1" step="0.05" value="0.4"></label>
  <label>Shape Opacity: <input type="range" id="shapeOpacity" min="0.1" max="1" step="0.05" value="0.55"></label>
</div>

<div class="game-buttons">
  <button id="tryAgainBtn">Try Again</button>
  <button id="nextShapeBtn">Next Shape</button>
</div>

<script>
const canvas = document.getElementById('drawCanvas');
const ctx = canvas.getContext('2d');

const tryAgainBtn = document.getElementById('tryAgainBtn');
const nextShapeBtn = document.getElementById('nextShapeBtn');
const toggleBtn = document.getElementById('toggleSettings');
const settingsPanel = document.getElementById('settingsPanel');

const leftColorInput = document.getElementById('leftColor');
const rightColorInput = document.getElementById('rightColor');
const swapColorsCheckbox = document.getElementById('swapColors');
const leftClarityInput = document.getElementById('leftClarity');
const rightClarityInput = document.getElementById('rightClarity');
const shapeOpacityInput = document.getElementById('shapeOpacity');

let width, height;
function resizeCanvas() {
  width = window.innerWidth;
  height = window.innerHeight - 120;
  canvas.width = width;
  canvas.height = height;
}
resizeCanvas();
window.addEventListener('resize', resizeCanvas);

// Shape settings
const shapes = ['circle', 'square', 'triangle', 'star', 'figureEight'];
let currentShapeIndex = 0;
let shapeX = 0, shapeY = 0;
let shapeSize = 0;
let shapeRotation = 0;

// Drawing state
let drawing = false;
ctx.lineCap = 'round';
const drawLineWidth = 8;

// Anaglyph toggle
let anaglyphMode = true;

// Utility: random number
function rand(min,max){return Math.random()*(max-min)+min;}

// Load next shape
function loadShape(next=true){
  if(next) currentShapeIndex = (currentShapeIndex + 1) % shapes.length;
  shapeSize = Math.min(width,height)*0.6;
  shapeX = rand(shapeSize/2, width-shapeSize/2);
  shapeY = rand(shapeSize/2, height-shapeSize/2);
  shapeRotation = rand(0, 2*Math.PI);
  drawCanvas();
}

// Draw shape
function drawShape(eye='left'){
  ctx.save();
  ctx.translate(shapeX, shapeY);
  ctx.rotate(shapeRotation);
  ctx.globalAlpha = parseFloat(shapeOpacityInput.value);

  ctx.beginPath(); // fresh path

  let color = eye==='left'?leftColorInput.value:rightColorInput.value;
  if(swapColorsCheckbox.checked) color = eye==='left'?rightColorInput.value:leftColorInput.value;
  ctx.strokeStyle = color;
  ctx.lineWidth = 10;

  const s = shapeSize;
  switch(shapes[currentShapeIndex]){
    case 'circle':
      ctx.arc(0,0,s/2,0,2*Math.PI); break;
    case 'square':
      ctx.rect(-s/2,-s/2,s,s); break;
    case 'triangle':
      ctx.moveTo(0,-s/2);
      ctx.lineTo(s/2,s/2);
      ctx.lineTo(-s/2,s/2);
      ctx.closePath(); break;
    case 'star':
      const spikes=5; const outer=s/2; const inner=s/4;
      for(let i=0;i<spikes;i++){
        const ang=i*2*Math.PI/spikes-Math.PI/2;
        const x=Math.cos(ang)*outer; const y=Math.sin(ang)*outer;
        if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
        const ang2=ang+Math.PI/spikes;
        ctx.lineTo(Math.cos(ang2)*inner,Math.sin(ang2)*inner);
      }
      ctx.closePath(); break;
    case 'figureEight':
      const r=s/4;
      ctx.moveTo(-r,0);
      ctx.bezierCurveTo(-r,-r,r,-r,r,0);
      ctx.bezierCurveTo(r,r,-r,r,-r,0); break;
  }

  ctx.stroke();
  ctx.restore();
  ctx.globalAlpha = 1;
  ctx.beginPath();
}

// Composite two-eye view for anaglyph
function drawCanvas(){
  ctx.clearRect(0,0,width,height);
  if(!anaglyphMode){
    drawShape('left'); drawShape('right'); return;
  }

  // draw left eye with clarity
  ctx.save();
  ctx.globalAlpha = parseFloat(leftClarityInput.value);
  drawShape('left');
  ctx.restore();

  // draw right eye with clarity
  ctx.save();
  ctx.globalAlpha = parseFloat(rightClarityInput.value);
  drawShape('right');
  ctx.restore();
}

// Drawing handlers
function startDrawing(e){drawing=true; draw(e);}
function stopDrawing(){drawing=false; ctx.beginPath();}
function draw(e){
  if(!drawing) return;
  e.preventDefault();
  let x,y;
  if(e.touches){
    const rect=canvas.getBoundingClientRect();
    x=e.touches[0].clientX - rect.left;
    y=e.touches[0].clientY - rect.top;
  } else { x=e.offsetX; y=e.offsetY; }

  let color = drawColorInput.value;
  if(swapColorsCheckbox.checked) color = leftColorInput.value;
  ctx.strokeStyle = color;
  ctx.lineWidth = drawLineWidth;

  ctx.lineTo(x,y); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(x,y);
}

// Event listeners
canvas.addEventListener('mousedown',startDrawing);
canvas.addEventListener('mouseup',stopDrawing);
canvas.addEventListener('mousemove',draw);
canvas.addEventListener('touchstart',startDrawing);
canvas.addEventListener('touchend',stopDrawing);
canvas.addEventListener('touchmove',draw);

tryAgainBtn.addEventListener('click',drawCanvas);
nextShapeBtn.addEventListener('click',()=>loadShape(true));
toggleBtn.addEventListener('click',()=>{settingsPanel.classList.toggle('open');});

// Initial shape
loadShape(false);
</script>

</body>
</html>
